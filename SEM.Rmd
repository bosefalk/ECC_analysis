---
title: "Structured Equation Modeling"
output: html_notebook
---

```{r}
library(lavaan)
library(ggplot2)
library(tidyverse)
source('lib/loading_scripts.R')

dat <- load_data('trustdem2')
#validate_data(dat)


```


```{r}
# Filter to keep only Denmark and one survery round for now
dat_DK4 <- dat %>% filter(essround == "4")
dat_DK4 %<>% filter(cntry == "DK")


```



# SEM model 1


```{r}
#https://www.draw.io/#G1VOWRneuwvycp48p7TP8YTj6darYgvRPW
# http://lavaan.ugent.be/tutorial/tutorial.pdf
# http://joophox.net/publist/semfamre.pdf
SEM_mod1 <- 'trst_gov =~ trstprl + trstlgl + trstplc + trstprt
  trst_ind =~ ppltrst + pplfair + pplhlp
  pol_news =~ tvpol + rdpol + nwsppol
  trst_gov ~ trst_ind + pol_news + netuse

  # Individual trust and news watching is not correlated
  trst_ind ~~ 0*pol_news
'

fit1 = sem(SEM_mod1, data = dat_DK4)
summary(fit1, fit.measures = TRUE)
```

```{r}

SEM_mod2 <- 'trst_gov =~ trstprl + trstlgl + trstplc + trstprt
  trst_ind =~ ppltrst + pplfair + pplhlp
  pol_news =~ tvpol + rdpol + nwsppol
  trst_gov ~ trst_ind + pol_news + netuse + hinctnta + agea

  # Individual trust and news watching is not correlated
  trst_ind ~~ 0*pol_news


  # Correlations
  agea ~~ netuse + hinctnta
'

fit2 = sem(SEM_mod2, data = dat_DK4)
summary(fit2, fit.measures = TRUE)

```



```{r}
# Just to test my understanding, invert one trust variable and we should see an Estimate with the opposite sign

dat_DK4$trstplc_inv <- abs(dat_DK4$trstplc - 10)

SEM_mod3 <- 'trst_gov =~ trstprl + trstlgl + trstplc_inv + trstprt
  pol_news =~ tvpol + rdpol + nwsppol
  trst_gov ~ pol_news + netuse'

fit3 = sem(SEM_mod3, data = dat_DK4)
summary(fit3, fit.measures = TRUE)



```


# Comparing studies within same country

```{r}
dat_DK5 <- dat %>% filter(essround == "5" & cntry == "DK")


fit_DK4 <- sem(SEM_mod2, data = dat_DK4)
fit_DK5 <- sem(SEM_mod2, data = dat_DK5)
```



```{r}
summary(fit_DK4, fit.measures = TRUE)
```


```{r}
summary(fit_DK5, fit.measures = TRUE)


```


# Estonia both surveys
```{r}
dat_EE5 <- dat %>% filter(essround == "5" & cntry == "EE")
dat_EE4 <- dat %>% filter(essround == "4" & cntry == "EE")


fit_EE4 <- sem(SEM_mod2, data = dat_EE4)
fit_EE5 <- sem(SEM_mod2, data = dat_EE5)

```

```{r}
summary(fit_EE4, fit.measures = TRUE)
```


```{r}
summary(fit_EE5, fit.measures = TRUE)
```


# CZ both surveys
```{r}
dat_CZ5 <- dat %>% filter(essround == "5" & cntry == "CZ")
dat_CZ4 <- dat %>% filter(essround == "4" & cntry == "CZ")


fit_CZ4 <- sem(SEM_mod2, data = dat_CZ4)
fit_CZ5 <- sem(SEM_mod2, data = dat_CZ5)

```

```{r}
summary(fit_CZ4, fit.measures = TRUE)

```

```{r}
summary(fit_CZ5, fit.measures = TRUE)

```


# Plots
```{r}
list_of_fits <- list("DK4" = fit_DK4, "DK5" = fit_DK5, 
                     "EE4" = fit_EE4, "EE5" = fit_EE5, 
                     "CZ4" = fit_CZ4, "CZ5" = fit_CZ5)

colour_scale = scale_colour_manual(values = c("DK4" = "green", "DK5" = "darkgreen", 
                                 "EE4" = "blue", "EE5" = "darkblue", 
                                 "CZ4" = "red", "CZ5" = "darkred"))

```

```{r}
params_list <- list()
for (i in 1:length(list_of_fits)) {
  params_list[[i]] <- parameterEstimates(list_of_fits[[i]])
  params_list[[i]]$source <- names(list_of_fits)[i]
  
}

params_df <- do.call(rbind, params_list)
params_df %<>% filter(lhs == 'trst_gov' & op == '~') %>% select(rhs, est, ci.lower, ci.upper, source)

ggplot(params_df, aes(x = rhs)) + 
  geom_pointrange(aes(y = est, ymin = ci.lower, ymax = ci.upper, colour = source), position=position_dodge(width=0.4)) + 
  geom_hline(yintercept = 0) +
  colour_scale +
  labs(title = "Coefficient Estimates", 
       x = "Variable", 
       y = "Estimate")


```

```{r}


fit_out_list <- list()
for (i in 1:length(list_of_fits)) {
  fit_out <- fitmeasures(list_of_fits[[i]])
  fit_out_list[[i]] <- data.frame(source = names(list_of_fits)[i], 
                       rmsea = fit_out['rmsea'], 
                       rmsea.ci.lower = fit_out['rmsea.ci.lower'], 
                       rmsea.ci.upper = fit_out['rmsea.ci.upper'])

}
fit_df <- do.call(rbind, fit_out_list)

ggplot(fit_df, aes(x = source)) + geom_pointrange(aes(y = rmsea, ymin = rmsea.ci.lower, ymax = rmsea.ci.upper, colour = source)) +
  colour_scale +
  expand_limits(y = 0) +
  geom_hline(yintercept = 0.1, lty = 3) +
  geom_hline(yintercept = 0.05, lty = 2) +
  geom_hline(yintercept = 0) +
  labs(title = "Root Mean Square Error of Approximation", 
       x = "Model", 
       y = "RMSEA")

```


# Mean-only model

```{r}
attach(dat)
trst_gov_mean <- mean(trstprl, trstlgl, trstplc, trstprt)
trst_ind_mean <- mean(ppltrst, pplfair, pplhlp)
pol_news_mean <- mean(tvpol, rdpol, nwsppol)
  


trst_gov ~ trst_ind + pol_news + netuse + hinctnta + agea

```



# Conclusions

Model works ok, not a great fit. Individual trust is biggest contributor to trusting government institutions, followed by household income - age is generally not important. Following political news generally means higher trust in government but not a strong correlation, and online use is not important